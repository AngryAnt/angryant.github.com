<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>AngryAnt - Co-very-routine - </title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/css/screen/base.css" type="text/css" media="screen" />
<link rel="stylesheet" href="/css/screen/site.css" type="text/css" media="screen" />
<link rel="stylesheet" href="/css/print/base.css" type="text/css" media="print" />
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34029666-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


		<link rel="author" href="https://plus.google.com/+EmilJohansen" />
	</head>
	<body>
		<div id="site">
			<div id="sidebar">
				<img id="logo" title="Logo" alt="Logo" src="/resources/logo.png">
<h1 class="header"><a href="/" style="padding:0; margin:0; float: none;">AngryAnt</a></h1>
<div id="subtitle">Co-very-routine</div>

	
		<a href="/">Home</a>
		
	

	
		<a href="/freelance">Freelance</a>
		
	

	
		<a href="/behave">Behave</a>
		
	

	
		<a href="/tools">Tools</a>
		
	

	
		<a href="/feed">Feed</a>
		
	

	
		<a href="/videos">Videos</a>
		
	


<div id="external">
	<a href="/feed.xml">RSS</a>
	<a href="/feed.articles.xml">Full RSS</a>
	<a href="https://gist.github.com/AngryAnt">Gist</a>
	<a href="https://twitter.com/AngryAnt">Twitter</a>
	<a href="http://www.linkedin.com/in/EmilJohansen">LinkedIn</a>
	<a href="http://lanyrd.com/profile/angryant/">Lanyrd</a>
</div>

			</div>
			<div id="container">
				<span class="date">20 Jun 2014</span>
				<h1 id="Top">Co-very-routine</h1>
				
				<div id="content">
					<div class="post"><p>I really like coroutines. Like with most things, they should be applied in well-considered quantities, but when applied they can really expand what you can achieve in just a few lines of code. Particularly in our frame-bound world.</p>
<p>However there has always been this little subset of extra things, which I would have liked to have seen supported by Unity coroutines out of the box.</p>
<p>&#8220;Hang on, weren&#8217;t you just there?&#8221;</p>
<p>Yep. I was and terrible as the excuse might be, there was always something that seemed shinier or more on fire.</p>
<p>Then at <a href="http://unity3d.com/unite">Unite 13</a>, Devin and Matthew of <a href="http://twistedoakstudios.com/">Twisted Oak Studios</a> did an excellent <a href="https://www.youtube.com/watch?v=ciDD6Wl-Evk">talk about extending coroutines</a> by using extension methods to insert a proxy layer between coroutines and the Unity coroutine-system. Unfortunately I didn&#8217;t catch the talk live (I don&#8217;t see many talks at conferences), but shortly after I could catch it on YouTube. Technology, yay!</p>
<p>In any case that really ended my supply of excuses, other than work.</p>
<p>Devin and Matthew had specifically implemented the setup to allow coroutines to provide a return value, provide a nicer stopping mechanism, as well as provide a useful way of handling exceptions thrown during the execution of coroutines. This provided an excellent platform to work off and did tick three items off my wishlist, but didn&#8217;t quite deliver the whole package.</p>
<p>It is an interesting talk and if you have the time, you should give it a look.</p>
<h1>The Whole Package</h1>
<p>So I slacked off doing work for a bit and somewhere in Q2 2014 got started writing my own implementation of extended coroutines, with the extra bits and bops on my list.</p>
<p>This here is the list:</p>
<ul>
	<li>Coroutines providing return values (yay! free!)</li>
	<li>Handle exceptions thrown during coroutine execution (yay! free!)</li>
	<li>Useful stopping behaviour (yay! free!)</li>
	<li>Built-in soft stop.</li>
	<li>Better built-in communication between caller and coroutine.</li>
	<li>Easier way of intermixing threading and coroutines.</li>
	<li>Built-in simple load balancing.</li>
</ul>
<h2>Soft Stop</h2>
<p>Straight up stopping a coroutine is fine, but dependent on what it was doing while being stopped, it might leave a mess behind. The idea with a soft stop mechanism is that in stead of directly stopping the coroutine, the external controller in stead requests that the coroutine stops.</p>
<p>This allows the coroutine to monitor the state of the requested stop flag at appropriate points in its execution and terminate with the necessary cleanup in response.</p>
<h2>Caller &#8211; Coroutine Communications</h2>
<p>But why stop the communications at just requesting a nice stop? What if the work produced by the coroutine could have relevance throughout its execution?</p>
<p>By making the result of the coroutine accessible before the completion of the coroutine, we gain the capability of not just reading it early on, but also contributing to its building from outside of the coroutine.</p>
<h2>Threading</h2>
<p>Sufficiently intense tasks, working on data types not tied to the UnityEngine, <span class="caps">API</span> can benefit from threading. Unfortunately, most of the time things aren&#8217;t that cleanly cut out, and only part of the task is suitable for threading.</p>
<p>At that point the alternatives are to either forget about partially threading the task or to bridge the two types of concurrency system. Since the latter rarely turns out very pretty, the former is often chosen.</p>
<p>Building threading right into the coroutine system makes the choice easy.</p>
<h2>Simple Load Balancing</h2>
<p>Finally, heavy tasks which for one reason or another cannot be threaded (perhaps the very nature of the task requires dealing with the UnityEngine <span class="caps">API</span>), can in stead be frame sliced inside a coroutine.</p>
<p>However the logic for doing so can be more or less pretty and writing boilerplate is boring. Clearly this would be great to also have built into the base coroutine system.</p>
<h1>Usage</h1>
<p>So that is the full wish list implemented. Now let&#8217;s take a look at some quick example snippets.</p>
<h2>Result</h2>
<p>The base interface for using the extended coroutines is to start them via the new generic version of <code>MonoBehaviour.StartCoroutine</code>.</p>
<p>For running regular coroutines, the only other difference is that in stead of yielding directly to the return value of <code>StartCoroutine&lt;T&gt;</code>, you yield to the .Coroutine member of its <code>CoroutineData&lt;T&gt;</code> return value.</p>
<p>This is also the reference which gives you access to the result of the coroutine execution.</p>
<script src='https://gist.github.com/.js?file=Result.cs'></script><div><noscript><pre><code></code></pre></noscript></div>
<ul>
	<li><a href="https://gist.githubusercontent.com/AngryAnt/a9cada6093e7d47bea1c/raw/Result.cs">Example</a></li>
</ul>
<h2>Exception</h2>
<p>Since the coroutine calls are executed by the coroutine system and not the callee, normally exceptions just get swallowed up by the coroutine system and logged out.</p>
<p>The approach of Devin and Matthew, as implemented here, is to swallow the exception, break coroutine execution and then re-throw the same exception when next the coroutine comes into contact with the caller &#8211; namely when its result is accessed.</p>
<script src='https://gist.github.com/.js?file=Exception.cs'></script><div><noscript><pre><code></code></pre></noscript></div>
<ul>
	<li><a href="https://gist.githubusercontent.com/AngryAnt/a9cada6093e7d47bea1c/raw/Exception.cs">Example</a></li>
</ul>
<h2>Stop</h2>
<p>In stead of relying on the strange, existing methods of stopping coroutines and the limitations they come with (such as only stopping a coroutine initially started by string parameter or stopping all coroutines on a behaviour), the <code>CoroutineData&lt;T&gt;</code> reference yields another possibility.</p>
<p>Since it effectively represents an instance of an executing coroutine, adding a <code>Stop</code> method to it becomes much more intuitive.</p>
<script src='https://gist.github.com/.js?file=Stop.cs'></script><div><noscript><pre><code></code></pre></noscript></div>
<ul>
	<li><a href="https://gist.githubusercontent.com/AngryAnt/a9cada6093e7d47bea1c/raw/Stop.cs">Example</a></li>
</ul>
<h2>Soft Stop</h2>
<p>Requesting that a coroutine stops, requires a line of communication between the caller and coroutine. This is provided in the form of the instance of <code>CoroutineData&lt;T&gt;</code>.</p>
<p>However in order to effectively pass this, the calling convention on the coroutine is slightly different. Rather than passing the return value of the coroutine to <code>StartCoroutine&lt;T&gt;</code>, the coroutine is passed as a delegate, taking <code>CoroutineData&lt;T&gt;</code> as its only parameter.</p>
<p>The rest of the flow is exactly as with <code>Stop</code>, except <code>RequestStop</code> is used by the caller and the coroutine periodically checks <code>CoroutineData&lt;T&gt;.ShouldStop</code>.</p>
<script src='https://gist.github.com/.js?file=SoftStop.cs'></script><div><noscript><pre><code></code></pre></noscript></div>
<ul>
	<li><a href="https://gist.githubusercontent.com/AngryAnt/a9cada6093e7d47bea1c/raw/SoftStop.cs">Example</a></li>
</ul>
<h2>Threading</h2>
<p>The interface for threading is really very simple. Two new yield classes have been added <code>WaitForWorkerThread</code> and <code>WaitForMainThread</code>. Yielding to an instance of either will do exactly as advertised. Yielding break or the result or throwing an exception will terminate the thread and the coroutine.</p>
<p>When yielding <code>WaitForSeconds</code> on the worker thread, the thread will sleep for the specified amount of seconds. And finally the <code>CoroutineData&lt;T&gt;</code> holds a flag accessor to determine the thread state of the coroutine.</p>
<script src='https://gist.github.com/.js?file=Threading.cs'></script><div><noscript><pre><code></code></pre></noscript></div>
<ul>
	<li><a href="https://gist.githubusercontent.com/AngryAnt/a9cada6093e7d47bea1c/raw/Threading.cs">Example</a></li>
</ul>
<h2>Load Balancing</h2>
<p>Load balancing could be done in a bunch of different ways and I would encourage you to add your own (I would love to see your ideas as well). So I decided to just do the simplest I could think of.</p>
<p><code>WaitIfFrameTime</code> will yield until the next frame if the current frame has taken longer than the specified amount of time. This way it effectively sets down a max frame time while utilising all the time leading up to that cap.</p>
<script src='https://gist.github.com/.js?file=Load.cs'></script><div><noscript><pre><code></code></pre></noscript></div>
<ul>
	<li><a href="https://gist.githubusercontent.com/AngryAnt/a9cada6093e7d47bea1c/raw/Load.cs">Example</a></li>
</ul>
<h1>Fin</h1>
<p>And that is it! I hope you find some use of these extensions to the extensions and do let me know if you come up with some cool further extensions.</p>
<ul>
	<li><a href="https://gist.github.com/AngryAnt/a9cada6093e7d47bea1c">Source and examples</a></li>
</ul></div>
				</div>
				<div id="feed-container">
					<div id="feed">
						
							<a href="/2015/06/13/Behave-2-6/" class="titleSmall">Behave 2.6</a><br />
						
							<a href="/2015/02/26/Trusted-Gear/" class="titleSmall">Trusted Gear</a><br />
						
							<a href="/2015/01/02/Mad-Mash-Versioning/" class="titleSmall">Mad Mash Versioning</a><br />
						
							<a href="/2015/01/01/Behave-2-5/" class="titleSmall">Behave 2.5</a><br />
						
							<a href="/2014/11/28/Behave-2-4/" class="titleSmall">Behave 2.4</a><br />
						
							<a href="/2014/06/20/Co-very-routine/" class="titleSmall">Co-very-routine</a><br />
						
							<a href="/2014/04/25/Construct/" class="titleSmall">Construct</a><br />
						
							<a href="/2014/03/25/The-Engine-Wars-Numbers/" class="titleSmall">The Engine Wars: Numbers</a><br />
						
							<a href="/2014/03/13/GDC-14-The-Quest-For-Fun/" class="titleSmall">GDC 14: The Quest For Fun</a><br />
						
							<a href="/2014/03/07/Moving-in-Unity/" class="titleSmall">Moving in Unity</a><br />
						
							<a href="/2014/02/27/Behave-2-3/" class="titleSmall">Behave 2.3</a><br />
						
							<a href="/2014/01/03/Unity-and-net-assemblies/" class="titleSmall">Unity and .net assemblies</a><br />
						
							<a href="/2013/12/23/Behave-2-2/" class="titleSmall">Behave 2.2</a><br />
						
							<a href="/2013/10/11/ReView/" class="titleSmall">ReView</a><br />
						
							<a href="/2013/10/06/Behave-2-1/" class="titleSmall">Behave 2.1</a><br />
						
							<a href="/2013/08/25/Behave-2-0/" class="titleSmall">Behave 2.0</a><br />
						
							<a href="/2013/08/04/Unity-Hacks-Dual-sticks/" class="titleSmall">Unity Hacks: Dual sticks</a><br />
						
							<a href="/2013/07/28/Unity-Hacks-Cameras/" class="titleSmall">Unity Hacks: Cameras</a><br />
						
							<a href="/2013/07/19/Unity-Hacks-Touch-gestures/" class="titleSmall">Unity Hacks: Touch gestures</a><br />
						
							<a href="/2013/07/17/OnRenderTextureGUI/" class="titleSmall">OnRenderTextureGUI</a><br />
						
							<a href="/2013/07/05/Unite-13-video-Unity-Hacks-available/" class="titleSmall">Unite 13 video "Unity Hacks" available</a><br />
						
							<a href="/2013/06/07/The-implicit-local-network-interface/" class="titleSmall">The implicit local network interface</a><br />
						
							<a href="/2013/05/21/Talks-and-progress/" class="titleSmall">Talks and progress</a><br />
						
							<a href="/2013/05/14/Five-years-of-Unity-expertise-looking-for-contracts/" class="titleSmall">Five years of Unity expertise looking for contracts</a><br />
						
							<a href="/2012/12/22/Automagic-Unity-Android-Java-gadget-OF-DOOM/" class="titleSmall">Automagic Unity Android Java gadget OF DOOM!</a><br />
						
							<a href="/2012/10/03/Invading-Planet-from-your-couch/" class="titleSmall">Invading Planet from your couch</a><br />
						
							<a href="/2012/09/28/Mountain-Lion-and-laggy-bluetooth-and-duct-tape/" class="titleSmall">Mountain Lion and laggy bluetooth and duct-tape</a><br />
						
							<a href="/2012/09/23/Unite-12-video-and-new-videos-section-available/" class="titleSmall">Unite 12 video and new videos section available</a><br />
						
							<a href="/2012/08/28/Asia-Bootcamp-videos-now-available/" class="titleSmall">Asia Bootcamp videos now available</a><br />
						
							<a href="/2012/05/17/path-is-now-mit-licensed/" class="titleSmall">Path is now MIT licensed</a><br />
						
							<a href="/2011/11/30/behave-1-4-released/" class="titleSmall">Behave 1.4 released</a><br />
						
							<a href="/2011/10/09/so-ive-been-a-bit-busy-lately/" class="titleSmall">So I've been a bit busy lately</a><br />
						
							<a href="/2011/04/28/behave-1-3-released/" class="titleSmall">Behave 1.3 released</a><br />
						
							<a href="/2011/04/23/igda-unity-sig-slides/" class="titleSmall">IGDA Unity SIG slides</a><br />
						
							<a href="/2011/03/17/second-unity-igda-sig-this-evening-scene-construction-and-ai/" class="titleSmall">Second Unity IGDA SIG this evening: Scene construction and AI</a><br />
						
							<a href="/2011/03/10/first-igda-unity-sig-this-evening/" class="titleSmall">First IGDA Unity SIG this evening</a><br />
						
							<a href="/2011/03/03/alternative-licensing-available/" class="titleSmall">Alternative licensing available</a><br />
						
							<a href="/2011/02/15/pathfinding-in-two-line/" class="titleSmall">Pathfinding in two lines</a><br />
						
							<a href="/2011/02/15/path-2-released/" class="titleSmall">Path 2 released</a><br />
						
							<a href="/2011/02/02/assembling-and-assimilating/" class="titleSmall">Assembling and assimilating</a><br />
						
							<a href="/2011/01/29/path-2-intro-screencast/" class="titleSmall">Path 2 intro screencast</a><br />
						
							<a href="/2011/01/29/path-2-beta-release-for-ggj/" class="titleSmall">Path 2 beta release for GGJ</a><br />
						
							<a href="/2011/01/25/aigamedev-master-class-video-now-online-3/" class="titleSmall">AIgameDev master class video now online</a><br />
						
							<a href="/2011/01/09/expanding-beta/" class="titleSmall">Expanding beta</a><br />
						
							<a href="/2010/11/28/behave-aigamedev-master-class-public-stream/" class="titleSmall">Behave AIgameDev master class public stream</a><br />
						
							<a href="/2010/11/27/behave-master-class-on-open-aigamedev-stream-tomorrow/" class="titleSmall">Behave master class on open AIgameDev stream tomorrow</a><br />
						
							<a href="/2010/10/29/interview-with-aigamedev/" class="titleSmall">Interview with AIGameDev</a><br />
						
							<a href="/2010/10/24/new-video-from-tree-to-code/" class="titleSmall">New video: From tree to code</a><br />
						
							<a href="/2010/10/23/issue-tracking-on-github-behave-release-project/" class="titleSmall">Issue tracking on github Behave release project</a><br />
						
							<a href="/2010/10/22/it-university-copenhagen-unity-course-completed/" class="titleSmall">IT University Copenhagen Unity course completed</a><br />
						
							<a href="/2010/10/21/it-university-copenhagen-unity-course-files-thursday/" class="titleSmall">IT University Copenhagen Unity course files Thursday</a><br />
						
							<a href="/2010/10/20/cph-it-university-unity-course-files/" class="titleSmall">CPH IT University Unity course files</a><br />
						
							<a href="/2010/10/11/behave-1-2-released/" class="titleSmall">Behave 1.2 released</a><br />
						
							<a href="/2010/09/29/video-behave-starting-from-scratch/" class="titleSmall">Video: Behave - starting from scratch</a><br />
						
							<a href="/2010/09/29/behave-runtime-documentation-updated/" class="titleSmall">Behave runtime documentation updated</a><br />
						
							<a href="/2010/09/29/behave-1-1-released/" class="titleSmall">Behave 1.1 released</a><br />
						
							<a href="/2010/03/19/faff-cleanup-sketch/" class="titleSmall">FAFF cleanup: Sketch</a><br />
						
							<a href="/2010/03/15/building-a-menu-of-delegates-and-enums/" class="titleSmall">Building a menu of delegates and enums</a><br />
						
							<a href="/2010/03/10/pick-me-pick-me/" class="titleSmall">Pick me! Pick me!</a><br />
						
							<a href="/2010/01/14/optimising-coroutine-yielding-in-c/" class="titleSmall">Optimising coroutine yielding in C#</a><br />
						
							<a href="/2010/01/05/downloading-the-hydra/" class="titleSmall">Downloading the hydra</a><br />
						
							<a href="/2009/11/15/new-license-of-path-gpl/" class="titleSmall">New license of Path: GPL</a><br />
						
							<a href="/2009/11/04/copyinspector/" class="titleSmall">CopyInspector</a><br />
						
							<a href="/2009/10/04/magnetic/" class="titleSmall">Magnetic</a><br />
						
							<a href="/2009/09/18/gui-drag-drop/" class="titleSmall">GUI drag-drop</a><br />
						
							<a href="/2009/09/17/logging-an-entire-gameobject/" class="titleSmall">Logging an entire GameObject</a><br />
						
							<a href="/2009/09/07/i-bet-you-cant-type-an-a/" class="titleSmall">I bet you can't type an A!</a><br />
						
							<a href="/2009/08/31/where-did-that-component-go/" class="titleSmall">Where did that component go?</a><br />
						
							<a href="/2009/08/19/unitysteer/" class="titleSmall">UnitySteer</a><br />
						
							<a href="/2009/05/18/new-and-improved-behave-10-released/" class="titleSmall">New and improved: Behave 1.0 released</a><br />
						
							<a href="/2009/04/08/behave-03b-and-unity-25/" class="titleSmall">Behave 0.3b and unity 2.5</a><br />
						
							<a href="/2009/03/20/behave-03b-hotfix/" class="titleSmall">Behave 0.3b hotfix</a><br />
						
							<a href="/2009/03/19/path-tutorial-video-available/" class="titleSmall">Path tutorial video available</a><br />
						
							<a href="/2009/03/18/path-10-launched/" class="titleSmall">Path 1.0 launched!</a><br />
						
							<a href="/2008/12/17/community-tutorial-2/" class="titleSmall">Continued community tutorials</a><br />
						
							<a href="/2008/11/30/community-tutorial/" class="titleSmall">Community tutorial</a><br />
						
							<a href="/2008/11/28/new-tutorial/" class="titleSmall">New tutorial</a><br />
						
							<a href="/2008/11/04/first-tutorial-available/" class="titleSmall">First tutorial available</a><br />
						
							<a href="/2008/11/02/behave-03b/" class="titleSmall">Behave 0.3b</a><br />
						
							<a href="/2008/10/25/unite-08-open-mic-session/" class="titleSmall">unite '08 open-mic session</a><br />
						
							<a href="/2008/09/24/behave-02b/" class="titleSmall">Behave 0.2b</a><br />
						
							<a href="/2008/09/09/behave-01b/" class="titleSmall">Behave 0.1b</a><br />
						
							<a href="/2008/09/08/behave-pre-release/" class="titleSmall">Behave pre-release</a><br />
						
							<a href="/2008/04/15/path-beta-03b/" class="titleSmall">Path beta 0.3b</a><br />
						
							<a href="/2008/04/12/path-beta-02b/" class="titleSmall">Path beta 0.2b</a><br />
						
							<a href="/2008/04/05/path-beta-01b/" class="titleSmall">Path beta 0.1b</a><br />
						
							<a href="/2008/03/30/path-pre-release/" class="titleSmall">Path pre-release</a><br />
						
					</div>
				</div>
				<div id="footer">
	<p class="footnote" style="margin-top: 50px; margin-bottom: 10px; clear: both;">Copyright &#169; AngryAnt&trade; <script>document.write ((new Date ()).getFullYear ());</script>. All public github gists are public domain.</p>
	<script>document.write ('<img src="/resources/footers/' + Math.floor (Math.random () * 23 + 1) + '.png" width="600" height="300" class="noprint" style="margin-bottom: -5px;">');</script>
</div>

			</div>
		</div>
		

	</body>
</html>
