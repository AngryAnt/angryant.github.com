<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>AngryAnt - The implicit local network interface - </title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/css/screen/base.css" type="text/css" media="screen" />
<link rel="stylesheet" href="/css/screen/site.css" type="text/css" media="screen" />
<link rel="stylesheet" href="/css/print/base.css" type="text/css" media="print" />
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34029666-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


		<link rel="author" href="https://plus.google.com/+EmilJohansen" />
	</head>
	<body>
		<div id="site">
			<div id="sidebar">
				<img id="logo" title="Logo" alt="Logo" src="/resources/logo.png">
<h1 class="header"><a href="/" style="padding:0; margin:0; float: none;">AngryAnt</a></h1>
<div id="subtitle">The implicit local network interface</div>

	
		<a href="/">Home</a>
		
	

	
		<a href="/freelance">Freelance</a>
		
	

	
		<a href="/behave">Behave</a>
		
	

	
		<a href="/tools">Tools</a>
		
	

	
		<a href="/feed">Feed</a>
		
	

	
		<a href="/videos">Videos</a>
		
	


<div id="availability">
	<a href="/freelance">Next availability: <span id="available">May</span></a>
</div>
<div id="external">
	<a href="/feed.xml">RSS</a>
	<a href="/feed.articles.xml">Full RSS</a>
	<a href="https://gist.github.com/AngryAnt">Gist</a>
	<a href="https://twitter.com/AngryAnt">Twitter</a>
	<a href="http://www.linkedin.com/in/EmilJohansen">LinkedIn</a>
	<a href="http://lanyrd.com/profile/angryant/">Lanyrd</a>
</div>

			</div>
			<div id="container">
				<span class="date">07 Jun 2013</span>
				<h1 id="Top">The implicit local network interface</h1>
				
				<div id="content">
					<div class="post"><p>I foolishly promised I would resume my posting of tech stuff on this blog, so I suppose I better own up to that.</p>
<h1>Story time</h1>
<p>You are playing some amazingly addictive game on your iOS device when commuting home. Let&#8217;s say it&#8217;s a Mario clone.</p>
<p>As you arrive home, you want more of this gaming goodness. So you switch on your television and use AirPlay to continue the game on your TV, controls on your iOS device, via your Apple TV or other AirServer hosting, TV connected, device.</p>
<p>Now your good friend Bob comes by (you forgot to lock the door, so he walks straight in). Obviously this game is too good to put down, so in stead you instruct Bob to buy a copy of it. Bob pulls out his android phone, jumps on your wifi, downloads the game and starts playing.</p>
<p>At one point in Bobs game he sees this funky spinning portal in the level and opts to tap it. And poof! Bobs character is sucked into your game on the TV.</p>
<p>Unfortunately Bob is a terrible player of this game and ruins your score, but it was pretty cool to try this game in multiplayer mode.</p>
<h1>Do want!</h1>
<p>The above scenario may sound complex to set up, but like so many other cases, it is just a nice combination of simpler bits. So let&#8217;s look into how we enable something like this in our (Unity based) game.</p>
<p>First up, AirPlay support was recently added to Unity and I posted <a href="https://gist.github.com/AngryAnt/5160204">a gist</a> to help people get started with it.</p>
<p>Secondly, we need to host a network game pretty much all the time, so that others may join any ongoing session at any time. Of-course you might want to provide an opt-in/out setting for networked play in your game. Just remember that we are only enabling this feature for local network play &#8211; not internet play like Journey did it.</p>
<p>For information on how to easily set up this network game, see the talk I did at Unite 12 in Amsterdam: &#8220;Unity, Network Code, and You&#8221; &#8211; the example provided for the built-in networking is quite relevant to the above example. You can find the talk linked from the <a href="/videos/">video</a> section of this site.</p>
<p>So with those parts in place, we just need a bit of glue &#8211; namely the broadcasting of games on your local network. This gist deals with just that:
<script src='https://gist.github.com/5730611.js?file=Broadcaster.cs'></script><div><noscript><pre><code>if (m_BroadcastTimer == null)
// Setup broadcast of hosting service
{
	m_BroadcastSocket = new Socket (AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);</p>
<p>try
	{
		IPAddress broadcastGroup = IPAddress.Parse (kBroadcastGroup);</p>
<p>m_BroadcastSocket.SetSocketOption (
			SocketOptionLevel.IP,
			SocketOptionName.AddMembership,
			new MulticastOption (broadcastGroup)
		);</p>
<p>m_BroadcastSocket.SetSocketOption (
			SocketOptionLevel.IP,
			SocketOptionName.MulticastTimeToLive,
			1
		);</p>
<p>m_BroadcastSocket.Connect (new IPEndPoint (broadcastGroup, kBroadcastPort));
	}
	catch (Exception e)
	{
		Debug.LogError (string.Format (
			&quot;Exception when attempting to set up service broadcast ({0}:{1}): {2}&quot;,
			kBroadcastGroup,
			kBroadcastPort,
			e
		));</p>
<p>return false;
	}</p>
<p>m_BroadcastTimer = new Timer (kBroadcastDelay);</p>
<p>m_BroadcastTimer.Elapsed += new ElapsedEventHandler (
		(object s, ElapsedEventArgs e) =&gt;
		{
			m_BroadcastSocket.Send (GetBroadcastBytes ());
		}
	);
	m_BroadcastTimer.Enabled = true;
}</p>
<p>return true;</p>
<p>// &#8230;</p>
<p>byte[] GetBroadcastBytes ()
{
	/*
		Return byte array containing IP and port of our host socket plus meta data
		such as current level and perhaps location (for portal placement)
	*/
}</code></pre></noscript></div></p>
<p>Let&#8217;s go over the interface for this gist:</p>
<p><strong>kBroadcastGroup</strong> and <strong>kBroadcastPort</strong> are effectively shared keys we use to facilitate broadcasting communication between game instances. Broadcasting happens by way of multi-casting &#8211; an IP protocol feature allowing peers to send one package to multiple unidentified receivers. This is why our shared keys are in the form of an IP address and a port, though their value is completely arbitrary &#8211; all that matters is that both broadcaster and receiver use the same keys.</p>
<p><strong>m_BroadcastTimer</strong> and <strong>kBroadcastDelay</strong> control how often <strong>m_BroadcastSocket</strong> will send out the broadcast message generated by <strong>GetBroadcastBytes</strong>.</p>
<p>This covers the transmission part of the broadcast functionality. The following gist deals with receiving the broadcast message:</p>
<script src='https://gist.github.com/5730611.js?file=Seeker.cs'></script><div><noscript><pre><code>if (m_SeekerSocket == null)
{
	m_SeekerSocket = new Socket (AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);

	try
	{
		m_SeekerSocket.Bind (new IPEndPoint (IPAddress.Any, kBroadcastPort));

		IPAddress broadcastGroup = IPAddress.Parse (kBroadcastGroup);

		m_SeekerSocket.SetSocketOption (
			SocketOptionLevel.IP,
			SocketOptionName.AddMembership,
			new MulticastOption (broadcastGroup, IPAddress.Any)
		);

		ReadBroadcasts ();
	}
	catch (Exception e)
	{
		Debug.LogError (string.Format (
			&amp;quot;Exception when attempting to set up service listener ({0}:{1}): {2}&amp;quot;,
			kBroadcastGroup,
			kBroadcastPort,
			e
		));

		m_SeekerSocket.Dispose ();
	}
}

// ...

void ReadBroadcasts ()
{
	/*
		Now set up periodic or event-driven reading from m_SeekerSocket, parsing
		broadcast packages containing IP, port and meta data of locally available games
	*/
}</code></pre></noscript></div>
<p>Like with the broadcaster, <strong>kBroadcastGroup</strong> and <strong>kBroadcastPort</strong> are used with the same values to make sure we are listening on the same multi-cast setup as the broadcaster.</p>
<p><strong>m_SeekerSocket</strong> is the socket on which broadcasts will be received &#8211; just like you would on any other reception socket.</p>
<p>And that is all there is to it. I hope you found it useful.</p></div>
				</div>
				<div id="feed-container">
					<div id="feed">
						
							<a href="/2014/03/25/The-Engine-Wars-Numbers/" class="titleSmall">The Engine Wars: Numbers</a><br />
						
							<a href="/2014/03/13/GDC-14-The-Quest-For-Fun/" class="titleSmall">GDC 14: The Quest For Fun</a><br />
						
							<a href="/2014/03/07/Moving-in-Unity/" class="titleSmall">Moving in Unity</a><br />
						
							<a href="/2014/02/27/Behave-2-3/" class="titleSmall">Behave 2.3</a><br />
						
							<a href="/2014/01/03/Unity-and-net-assemblies/" class="titleSmall">Unity and .net assemblies</a><br />
						
							<a href="/2013/12/23/Behave-2-2/" class="titleSmall">Behave 2.2</a><br />
						
							<a href="/2013/10/11/ReView/" class="titleSmall">ReView</a><br />
						
							<a href="/2013/10/06/Behave-2-1/" class="titleSmall">Behave 2.1</a><br />
						
							<a href="/2013/08/25/Behave-2-0/" class="titleSmall">Behave 2.0</a><br />
						
							<a href="/2013/08/04/Unity-Hacks-Dual-sticks/" class="titleSmall">Unity Hacks: Dual sticks</a><br />
						
							<a href="/2013/07/28/Unity-Hacks-Cameras/" class="titleSmall">Unity Hacks: Cameras</a><br />
						
							<a href="/2013/07/19/Unity-Hacks-Touch-gestures/" class="titleSmall">Unity Hacks: Touch gestures</a><br />
						
							<a href="/2013/07/17/OnRenderTextureGUI/" class="titleSmall">OnRenderTextureGUI</a><br />
						
							<a href="/2013/07/05/Unite-13-video-Unity-Hacks-available/" class="titleSmall">Unite 13 video "Unity Hacks" available</a><br />
						
							<a href="/2013/06/07/The-implicit-local-network-interface/" class="titleSmall">The implicit local network interface</a><br />
						
							<a href="/2013/05/21/Talks-and-progress/" class="titleSmall">Talks and progress</a><br />
						
							<a href="/2013/05/14/Five-years-of-Unity-expertise-looking-for-contracts/" class="titleSmall">Five years of Unity expertise looking for contracts</a><br />
						
							<a href="/2012/12/22/Automagic-Unity-Android-Java-gadget-OF-DOOM/" class="titleSmall">Automagic Unity Android Java gadget OF DOOM!</a><br />
						
							<a href="/2012/10/03/Invading-Planet-from-your-couch/" class="titleSmall">Invading Planet from your couch</a><br />
						
							<a href="/2012/09/28/Mountain-Lion-and-laggy-bluetooth-and-duct-tape/" class="titleSmall">Mountain Lion and laggy bluetooth and duct-tape</a><br />
						
							<a href="/2012/09/23/Unite-12-video-and-new-videos-section-available/" class="titleSmall">Unite 12 video and new videos section available</a><br />
						
							<a href="/2012/08/28/Asia-Bootcamp-videos-now-available/" class="titleSmall">Asia Bootcamp videos now available</a><br />
						
							<a href="/2012/05/17/path-is-now-mit-licensed/" class="titleSmall">Path is now MIT licensed</a><br />
						
							<a href="/2011/11/30/behave-1-4-released/" class="titleSmall">Behave 1.4 released</a><br />
						
							<a href="/2011/10/09/so-ive-been-a-bit-busy-lately/" class="titleSmall">So I've been a bit busy lately</a><br />
						
							<a href="/2011/04/28/behave-1-3-released/" class="titleSmall">Behave 1.3 released</a><br />
						
							<a href="/2011/04/23/igda-unity-sig-slides/" class="titleSmall">IGDA Unity SIG slides</a><br />
						
							<a href="/2011/03/17/second-unity-igda-sig-this-evening-scene-construction-and-ai/" class="titleSmall">Second Unity IGDA SIG this evening: Scene construction and AI</a><br />
						
							<a href="/2011/03/10/first-igda-unity-sig-this-evening/" class="titleSmall">First IGDA Unity SIG this evening</a><br />
						
							<a href="/2011/03/03/alternative-licensing-available/" class="titleSmall">Alternative licensing available</a><br />
						
							<a href="/2011/02/15/pathfinding-in-two-line/" class="titleSmall">Pathfinding in two lines</a><br />
						
							<a href="/2011/02/15/path-2-released/" class="titleSmall">Path 2 released</a><br />
						
							<a href="/2011/02/02/assembling-and-assimilating/" class="titleSmall">Assembling and assimilating</a><br />
						
							<a href="/2011/01/29/path-2-intro-screencast/" class="titleSmall">Path 2 intro screencast</a><br />
						
							<a href="/2011/01/29/path-2-beta-release-for-ggj/" class="titleSmall">Path 2 beta release for GGJ</a><br />
						
							<a href="/2011/01/25/aigamedev-master-class-video-now-online-3/" class="titleSmall">AIgameDev master class video now online</a><br />
						
							<a href="/2011/01/09/expanding-beta/" class="titleSmall">Expanding beta</a><br />
						
							<a href="/2010/11/28/behave-aigamedev-master-class-public-stream/" class="titleSmall">Behave AIgameDev master class public stream</a><br />
						
							<a href="/2010/11/27/behave-master-class-on-open-aigamedev-stream-tomorrow/" class="titleSmall">Behave master class on open AIgameDev stream tomorrow</a><br />
						
							<a href="/2010/10/29/interview-with-aigamedev/" class="titleSmall">Interview with AIGameDev</a><br />
						
							<a href="/2010/10/24/new-video-from-tree-to-code/" class="titleSmall">New video: From tree to code</a><br />
						
							<a href="/2010/10/23/issue-tracking-on-github-behave-release-project/" class="titleSmall">Issue tracking on github Behave release project</a><br />
						
							<a href="/2010/10/22/it-university-copenhagen-unity-course-completed/" class="titleSmall">IT University Copenhagen Unity course completed</a><br />
						
							<a href="/2010/10/21/it-university-copenhagen-unity-course-files-thursday/" class="titleSmall">IT University Copenhagen Unity course files Thursday</a><br />
						
							<a href="/2010/10/20/cph-it-university-unity-course-files/" class="titleSmall">CPH IT University Unity course files</a><br />
						
							<a href="/2010/10/11/behave-1-2-released/" class="titleSmall">Behave 1.2 released</a><br />
						
							<a href="/2010/09/29/video-behave-starting-from-scratch/" class="titleSmall">Video: Behave - starting from scratch</a><br />
						
							<a href="/2010/09/29/behave-runtime-documentation-updated/" class="titleSmall">Behave runtime documentation updated</a><br />
						
							<a href="/2010/09/29/behave-1-1-released/" class="titleSmall">Behave 1.1 released</a><br />
						
							<a href="/2010/03/19/faff-cleanup-sketch/" class="titleSmall">FAFF cleanup: Sketch</a><br />
						
							<a href="/2010/03/15/building-a-menu-of-delegates-and-enums/" class="titleSmall">Building a menu of delegates and enums</a><br />
						
							<a href="/2010/03/10/pick-me-pick-me/" class="titleSmall">Pick me! Pick me!</a><br />
						
							<a href="/2010/01/14/optimising-coroutine-yielding-in-c/" class="titleSmall">Optimising coroutine yielding in C#</a><br />
						
							<a href="/2010/01/05/downloading-the-hydra/" class="titleSmall">Downloading the hydra</a><br />
						
							<a href="/2009/11/15/new-license-of-path-gpl/" class="titleSmall">New license of Path: GPL</a><br />
						
							<a href="/2009/11/04/copyinspector/" class="titleSmall">CopyInspector</a><br />
						
							<a href="/2009/10/04/magnetic/" class="titleSmall">Magnetic</a><br />
						
							<a href="/2009/09/18/gui-drag-drop/" class="titleSmall">GUI drag-drop</a><br />
						
							<a href="/2009/09/17/logging-an-entire-gameobject/" class="titleSmall">Logging an entire GameObject</a><br />
						
							<a href="/2009/09/07/i-bet-you-cant-type-an-a/" class="titleSmall">I bet you can't type an A!</a><br />
						
							<a href="/2009/08/31/where-did-that-component-go/" class="titleSmall">Where did that component go?</a><br />
						
							<a href="/2009/08/19/unitysteer/" class="titleSmall">UnitySteer</a><br />
						
							<a href="/2009/05/18/new-and-improved-behave-10-released/" class="titleSmall">New and improved: Behave 1.0 released</a><br />
						
							<a href="/2009/04/08/behave-03b-and-unity-25/" class="titleSmall">Behave 0.3b and unity 2.5</a><br />
						
							<a href="/2009/03/20/behave-03b-hotfix/" class="titleSmall">Behave 0.3b hotfix</a><br />
						
							<a href="/2009/03/19/path-tutorial-video-available/" class="titleSmall">Path tutorial video available</a><br />
						
							<a href="/2009/03/18/path-10-launched/" class="titleSmall">Path 1.0 launched!</a><br />
						
							<a href="/2008/12/17/community-tutorial-2/" class="titleSmall">Continued community tutorials</a><br />
						
							<a href="/2008/11/30/community-tutorial/" class="titleSmall">Community tutorial</a><br />
						
							<a href="/2008/11/28/new-tutorial/" class="titleSmall">New tutorial</a><br />
						
							<a href="/2008/11/04/first-tutorial-available/" class="titleSmall">First tutorial available</a><br />
						
							<a href="/2008/11/02/behave-03b/" class="titleSmall">Behave 0.3b</a><br />
						
							<a href="/2008/10/25/unite-08-open-mic-session/" class="titleSmall">unite '08 open-mic session</a><br />
						
							<a href="/2008/09/24/behave-02b/" class="titleSmall">Behave 0.2b</a><br />
						
							<a href="/2008/09/09/behave-01b/" class="titleSmall">Behave 0.1b</a><br />
						
							<a href="/2008/09/08/behave-pre-release/" class="titleSmall">Behave pre-release</a><br />
						
							<a href="/2008/04/15/path-beta-03b/" class="titleSmall">Path beta 0.3b</a><br />
						
							<a href="/2008/04/12/path-beta-02b/" class="titleSmall">Path beta 0.2b</a><br />
						
							<a href="/2008/04/05/path-beta-01b/" class="titleSmall">Path beta 0.1b</a><br />
						
							<a href="/2008/03/30/path-pre-release/" class="titleSmall">Path pre-release</a><br />
						
					</div>
				</div>
				<div id="footer">
	<p class="footnote" style="margin-top: 50px; margin-bottom: 10px; clear: both;">Copyright &#169; AngryAnt&trade; <script>document.write ((new Date ()).getFullYear ());</script>. All public github gists are public domain.</p>
	<script>document.write ('<img src="/resources/footers/' + Math.floor (Math.random () * 23 + 1) + '.png" width="600" height="300" class="noprint" style="margin-bottom: -5px;">');</script>
</div>

			</div>
		</div>
		

	</body>
</html>
