<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>AngryAnt - Unity Protocol Buffers</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/css/screen/base.css" type="text/css" media="screen" />
<link rel="stylesheet" href="/css/screen/site.css" type="text/css" media="screen" />
<link rel="stylesheet" href="/css/print/base.css" type="text/css" media="print" />
<!-- No more Google Analytics, because no -->


		<link rel="author" href="http://AngryAnt.name" />
	</head>
	<body>
		<div id="site">
			<div id="sidebar">
				<h1 class="header"><a href="/" style="padding:0; margin:0; float: none;">AngryAnt</a><img id="logo" title="Logo" alt="Logo" src="/resources/logo.png"></h1>

			</div>
			<div id="container">
				<span class="date">17 Feb 2017</span>
				<h1 id="Top">Unity Protocol Buffers</h1>
				
				<div id="content">
					<div class="post"><p>Time for another &#8220;ah, crap &#8211; better put <strong>something</strong> up here before heading to <span class="caps">GDC</span>&#8221;-post. And since I did some re-tinkering with the integration of <a href="https://developers.google.com/protocol-buffers/">protobuf</a> in Behave late last year, some sharing on that topic seemed in order.</p>
<p>So yes, stuff is happening with Behave &#8211; no abandonment has taken place. On the contrary I have been working on several, long-running, feature branches. I&#8217;ll get around to merging some of those in and doing another release. More on that soonish.</p>
<p>Anywho, last I checked, <a href="https://github.com/mgravell/protobuf-net">protobuf-net</a> was still a more complete solution than the younger <a href="https://github.com/google/protobuf/tree/master/csharp">protobuf for C#</a> one, so I still stick with protobuf-net and can therefore only talk about that here. However it looks like the latter is seeing more rapid development, so I&#8217;ll probably review my choice when next I need to tinker with the integration.</p>
<p>More interestingly, some of the initial people behind protobuf have since gone and built the new and shiny <a href="https://capnproto.org">Cap&#8217;n Proto</a>. This looks to be even more powerful than its predecessor, but at time of writing it is still not as mature or implementation-rich as protobuf. Critically for the context of this post, there is no C# implementation yet. Cool stuff, though &#8211; worth keeping an eye on.</p>
<h2>Overview</h2>
<p>So what is the Protocol Buffers project? Succinctly, it is a compact binary serialisation format with very fast cross-platform and -language implementations. Super useful when you need to quickly move some data between memory and some other location &#8211; a file / a network peer / whatever.</p>
<p>It was first designed, implemented, and maintained by Google for communications between network peers on their internal network. Since then, it has been implemented in a number of different languages &#8211; including the <a href="https://github.com/mgravell/protobuf-net">protobuf-net</a> implementation, built and maintained by <a href="https://github.com/mgravell">Marc Gravell</a>.</p>
<p>Serialisation use in Behave has gone through a couple of distinct phases:</p>
<ol>
	<li>.net binary serialiser for asset.</li>
	<li>protobuf-net for asset.</li>
	<li>protobuf-net for asset and remote debugger protocol.</li>
	<li><span class="caps">JSON</span> for asset, protobuf-net for remote debugger protocol.</li>
</ol>
<p>Additionally I&#8217;ve used protobuf-net for runtime saving or build pipelines on various client projects.</p>
<p>Aside from speed and compression, protobuf-net vs. the .net binary serialiser was also an escape of the frustrating lack of support for versioning or even simple structural refactors of serialised types. The switch to <span class="caps">JSON</span> for the .behave asset files of-course came when I decided that merge-ability could be a fun thing to support.</p>
<p>On top of this general migration, I also went through a couple of different protobuf-net integrations &#8211; as my use cases and requirements changed. It just so happens that this gave me full coverage of the three approaches supported by protobuf-net, so no need for extra research before writing this post. Win!</p>
<h2>Integration</h2>
<p>For serialisation to work, you need a a serialiser and a schema. Protobuf-net offers a couple of ways for you to provide those:</p>
<ol>
	<li>[Attribute] markup with runtime generated serialiser.</li>
	<li>[Attribute] markup with pre-generated serialiser.</li>
	<li>.proto file description with pre-generated serialiser.</li>
</ol>
<p>I did this list in order of simplicity, which also happens to be the order in which I switched through them in the integration with Behave.</p>
<p>The first option is very .net esque and protobuf-net is indeed compatible both with its own serialisation attributes and the more general-purpose .net serialisation attributes. However since your interest here is in a Unity context, I&#8217;m sure that you have already spotted the problem with this approach.</p>
<p>Given that my initial use for protobuf-net was just for asset serialisation (which is editor-time only), I had no problem with the serialisation solution relying on <span class="caps">JIT</span> compilation in order to construct the serialiser at runtime. However as soon as I expanded my use case to include the runtime debugger, relying on <span class="caps">JIT</span> would mean not supporting the debugger on <span class="caps">AOT</span> platforms like iOS and consoles. Further, as Unity continues transitioning to their IL2CPP solution, you&#8217;re looking at a future where most will want to do <span class="caps">AOT</span> on all platforms.</p>
<p>So when introducing the remote debugger (previous debugger implementation was just 100% in-editor), I started to pre-generate the serialiser. This entails feeding your compiled assembly with [Attribute] markup to the protobuf-net precompile tool, which in turn generates an assembly with the serialiser type. For an example of how I used to do that, here&#8217;s a <a href="https://gist.github.com/AngryAnt/7223d692ec9d2fd12053e5b04f57296a">snippet of perl</a>.</p>
<h2>Extraction</h2>
<p>Everything works! Win, right? Well&#8230; as I was expanding debugger support to non-C# targets and doing a general code cleanup, I got increasingly annoyed by having serialisation implementation detail in my general data type code. So I started looking at how protobuf-net supports the standard protobuf .proto format for schema definition.</p>
<p>As things stand, it takes a bit of work &#8211; specifically <a href="https://github.com/mgravell/protobuf-net/pull/163">this work</a> &#8211; to get going, but once there it is solid. In stead of using the precompile tool, you need to build and run the protogen tool from the protobuf-net repository. If you&#8217;re on Windows, things may just work straight out of the gate, but you may want to see what is in my patch anyway.</p>
<p>So how does this work? Well, the input is no longer [attribute] marked assemblies, but in stead a .proto definition file. You can find great detail on that in the general <a href="https://developers.google.com/protocol-buffers/">protobuf</a> documentation, but you may want to consult the <a href="https://github.com/mgravell/protobuf-net">protobuf-net</a> docs for implementation specifics/limits. Also, the output is not an assembly, but simply a C# file.</p>
<p>Keep in mind that protogen relies on the protoc tool from the general Google protobuf tools. I fetched this from homebrew as the &#8220;protobuf&#8221; package.</p>
<p>Again I have a <a href="https://gist.github.com/AngryAnt/16c548412cdf1dba30140e8cdd97dc64">snippet of perl</a> to illustrate use &#8211; as well as an <a href="https://gist.github.com/AngryAnt/f053be0c4c66fafde17d679c2d09a9c9">example .proto file</a>. In this case the Behave debugger protocol definition.</p>
<p>Using this approach, I now have a nicely separated codebase and no duplication of schema definition between the C# debugger runtime and others. One trick remains though&#8230;</p>
<h2>Object pooling</h2>
<p>A mildly active Behave debugger session involves a lot of messages. I have very little interest in blowing up the garbage collector by constantly instantiating new messages and leaving them to get collected. So how do we integrate an object pool setup with the generated protobuf-net serialiser?</p>
<p>While not exactly as pretty as I would like, my answer is making use of the partialness of the generated types &#8211; in order to add <a href="https://gist.github.com/AngryAnt/1ed005b443202f6dcebc9649d59ae2d2">a static pool and -constructor</a> to hook it up.</p>
<p>And that&#8217;s pretty much what I&#8217;ve got. If I missed something or you have related questions, feel free to ping me and I&#8217;ll try to update this post when I can.</p>
<ul>
	<li><a href="https://developers.google.com/protocol-buffers/">protobuf</a></li>
	<li><a href="https://github.com/mgravell/protobuf-net">protobuf-net</a></li>
	<li><a href="https://github.com/google/protobuf/tree/master/csharp">protobuf for C#</a></li>
	<li><a href="https://capnproto.org">Cap&#8217;n Proto</a></li>
	<li><a href="https://github.com/mgravell">Marc Gravell</a></li>
	<li><a href="https://gist.github.com/AngryAnt/7223d692ec9d2fd12053e5b04f57296a">Precompiler perl</a></li>
	<li><a href="https://github.com/mgravell/protobuf-net/pull/163">protogen patch</a></li>
	<li><a href="https://gist.github.com/AngryAnt/16c548412cdf1dba30140e8cdd97dc64">protogen perl</a></li>
	<li><a href="https://gist.github.com/AngryAnt/f053be0c4c66fafde17d679c2d09a9c9">Protocol.proto</a></li>
	<li><a href="https://gist.github.com/AngryAnt/1ed005b443202f6dcebc9649d59ae2d2">Object pool integration</a></li>
</ul>








</div>
				</div>
				<div id="feed-container">
					<div id="feed">
						
							<a href="/2017/12/28/A-Change-of-Gears/" class="titleSmall">A Change of Gears</a><br />
						
							<a href="/2017/07/04/CoreObject/" class="titleSmall">CoreObject</a><br />
						
							<a href="/2017/02/17/Unity-Protocol-Buffers/" class="titleSmall">Unity Protocol Buffers</a><br />
						
							<a href="/2016/02/13/Behave-2-7/" class="titleSmall">Behave 2.7</a><br />
						
							<a href="/2015/07/17/Learn/" class="titleSmall">Learn</a><br />
						
							<a href="/2015/06/13/Behave-2-6/" class="titleSmall">Behave 2.6</a><br />
						
							<a href="/2015/02/26/Trusted-Gear/" class="titleSmall">Trusted Gear</a><br />
						
							<a href="/2015/01/02/Mad-Mash-Versioning/" class="titleSmall">Mad Mash Versioning</a><br />
						
							<a href="/2015/01/01/Behave-2-5/" class="titleSmall">Behave 2.5</a><br />
						
							<a href="/2014/11/28/Behave-2-4/" class="titleSmall">Behave 2.4</a><br />
						
							<a href="/2014/06/20/Co-very-routine/" class="titleSmall">Co-very-routine</a><br />
						
							<a href="/2014/04/25/Construct/" class="titleSmall">Construct</a><br />
						
							<a href="/2014/03/25/The-Engine-Wars-Numbers/" class="titleSmall">The Engine Wars: Numbers</a><br />
						
							<a href="/2014/03/13/GDC-14-The-Quest-For-Fun/" class="titleSmall">GDC 14: The Quest For Fun</a><br />
						
							<a href="/2014/03/07/Moving-in-Unity/" class="titleSmall">Moving in Unity</a><br />
						
							<a href="/2014/02/27/Behave-2-3/" class="titleSmall">Behave 2.3</a><br />
						
							<a href="/2014/01/03/Unity-and-net-assemblies/" class="titleSmall">Unity and .net assemblies</a><br />
						
							<a href="/2013/12/23/Behave-2-2/" class="titleSmall">Behave 2.2</a><br />
						
							<a href="/2013/10/11/ReView/" class="titleSmall">ReView</a><br />
						
							<a href="/2013/10/06/Behave-2-1/" class="titleSmall">Behave 2.1</a><br />
						
							<a href="/2013/08/25/Behave-2-0/" class="titleSmall">Behave 2.0</a><br />
						
							<a href="/2013/08/04/Unity-Hacks-Dual-sticks/" class="titleSmall">Unity Hacks: Dual sticks</a><br />
						
							<a href="/2013/07/28/Unity-Hacks-Cameras/" class="titleSmall">Unity Hacks: Cameras</a><br />
						
							<a href="/2013/07/19/Unity-Hacks-Touch-gestures/" class="titleSmall">Unity Hacks: Touch gestures</a><br />
						
							<a href="/2013/07/17/OnRenderTextureGUI/" class="titleSmall">OnRenderTextureGUI</a><br />
						
							<a href="/2013/07/05/Unite-13-video-Unity-Hacks-available/" class="titleSmall">Unite 13 video "Unity Hacks" available</a><br />
						
							<a href="/2013/06/07/The-implicit-local-network-interface/" class="titleSmall">The implicit local network interface</a><br />
						
							<a href="/2013/05/21/Talks-and-progress/" class="titleSmall">Talks and progress</a><br />
						
							<a href="/2013/05/14/Five-years-of-Unity-expertise-looking-for-contracts/" class="titleSmall">Five years of Unity expertise looking for contracts</a><br />
						
							<a href="/2012/12/22/Automagic-Unity-Android-Java-gadget-OF-DOOM/" class="titleSmall">Automagic Unity Android Java gadget OF DOOM!</a><br />
						
							<a href="/2012/10/03/Invading-Planet-from-your-couch/" class="titleSmall">Invading Planet from your couch</a><br />
						
							<a href="/2012/09/28/Mountain-Lion-and-laggy-bluetooth-and-duct-tape/" class="titleSmall">Mountain Lion and laggy bluetooth and duct-tape</a><br />
						
							<a href="/2012/09/23/Unite-12-video-and-new-videos-section-available/" class="titleSmall">Unite 12 video and new videos section available</a><br />
						
							<a href="/2012/08/28/Asia-Bootcamp-videos-now-available/" class="titleSmall">Asia Bootcamp videos now available</a><br />
						
							<a href="/2012/05/17/path-is-now-mit-licensed/" class="titleSmall">Path is now MIT licensed</a><br />
						
							<a href="/2011/11/30/behave-1-4-released/" class="titleSmall">Behave 1.4 released</a><br />
						
							<a href="/2011/10/09/so-ive-been-a-bit-busy-lately/" class="titleSmall">So I've been a bit busy lately</a><br />
						
							<a href="/2011/04/28/behave-1-3-released/" class="titleSmall">Behave 1.3 released</a><br />
						
							<a href="/2011/04/23/igda-unity-sig-slides/" class="titleSmall">IGDA Unity SIG slides</a><br />
						
							<a href="/2011/03/17/second-unity-igda-sig-this-evening-scene-construction-and-ai/" class="titleSmall">Second Unity IGDA SIG this evening: Scene construction and AI</a><br />
						
							<a href="/2011/03/10/first-igda-unity-sig-this-evening/" class="titleSmall">First IGDA Unity SIG this evening</a><br />
						
							<a href="/2011/03/03/alternative-licensing-available/" class="titleSmall">Alternative licensing available</a><br />
						
							<a href="/2011/02/15/pathfinding-in-two-line/" class="titleSmall">Pathfinding in two lines</a><br />
						
							<a href="/2011/02/15/path-2-released/" class="titleSmall">Path 2 released</a><br />
						
							<a href="/2011/02/02/assembling-and-assimilating/" class="titleSmall">Assembling and assimilating</a><br />
						
							<a href="/2011/01/29/path-2-intro-screencast/" class="titleSmall">Path 2 intro screencast</a><br />
						
							<a href="/2011/01/29/path-2-beta-release-for-ggj/" class="titleSmall">Path 2 beta release for GGJ</a><br />
						
							<a href="/2011/01/25/aigamedev-master-class-video-now-online-3/" class="titleSmall">AIgameDev master class video now online</a><br />
						
							<a href="/2011/01/09/expanding-beta/" class="titleSmall">Expanding beta</a><br />
						
							<a href="/2010/11/28/behave-aigamedev-master-class-public-stream/" class="titleSmall">Behave AIgameDev master class public stream</a><br />
						
							<a href="/2010/11/27/behave-master-class-on-open-aigamedev-stream-tomorrow/" class="titleSmall">Behave master class on open AIgameDev stream tomorrow</a><br />
						
							<a href="/2010/10/29/interview-with-aigamedev/" class="titleSmall">Interview with AIGameDev</a><br />
						
							<a href="/2010/10/24/new-video-from-tree-to-code/" class="titleSmall">New video: From tree to code</a><br />
						
							<a href="/2010/10/23/issue-tracking-on-github-behave-release-project/" class="titleSmall">Issue tracking on github Behave release project</a><br />
						
							<a href="/2010/10/22/it-university-copenhagen-unity-course-completed/" class="titleSmall">IT University Copenhagen Unity course completed</a><br />
						
							<a href="/2010/10/21/it-university-copenhagen-unity-course-files-thursday/" class="titleSmall">IT University Copenhagen Unity course files Thursday</a><br />
						
							<a href="/2010/10/20/cph-it-university-unity-course-files/" class="titleSmall">CPH IT University Unity course files</a><br />
						
							<a href="/2010/10/11/behave-1-2-released/" class="titleSmall">Behave 1.2 released</a><br />
						
							<a href="/2010/09/29/video-behave-starting-from-scratch/" class="titleSmall">Video: Behave - starting from scratch</a><br />
						
							<a href="/2010/09/29/behave-runtime-documentation-updated/" class="titleSmall">Behave runtime documentation updated</a><br />
						
							<a href="/2010/09/29/behave-1-1-released/" class="titleSmall">Behave 1.1 released</a><br />
						
							<a href="/2010/03/19/faff-cleanup-sketch/" class="titleSmall">FAFF cleanup: Sketch</a><br />
						
							<a href="/2010/03/15/building-a-menu-of-delegates-and-enums/" class="titleSmall">Building a menu of delegates and enums</a><br />
						
							<a href="/2010/03/10/pick-me-pick-me/" class="titleSmall">Pick me! Pick me!</a><br />
						
							<a href="/2010/01/14/optimising-coroutine-yielding-in-c/" class="titleSmall">Optimising coroutine yielding in C#</a><br />
						
							<a href="/2010/01/05/downloading-the-hydra/" class="titleSmall">Downloading the hydra</a><br />
						
							<a href="/2009/11/15/new-license-of-path-gpl/" class="titleSmall">New license of Path: GPL</a><br />
						
							<a href="/2009/11/04/copyinspector/" class="titleSmall">CopyInspector</a><br />
						
							<a href="/2009/10/04/magnetic/" class="titleSmall">Magnetic</a><br />
						
							<a href="/2009/09/18/gui-drag-drop/" class="titleSmall">GUI drag-drop</a><br />
						
							<a href="/2009/09/17/logging-an-entire-gameobject/" class="titleSmall">Logging an entire GameObject</a><br />
						
							<a href="/2009/09/07/i-bet-you-cant-type-an-a/" class="titleSmall">I bet you can't type an A!</a><br />
						
							<a href="/2009/08/31/where-did-that-component-go/" class="titleSmall">Where did that component go?</a><br />
						
							<a href="/2009/08/19/unitysteer/" class="titleSmall">UnitySteer</a><br />
						
							<a href="/2009/05/18/new-and-improved-behave-10-released/" class="titleSmall">New and improved: Behave 1.0 released</a><br />
						
							<a href="/2009/04/08/behave-03b-and-unity-25/" class="titleSmall">Behave 0.3b and unity 2.5</a><br />
						
							<a href="/2009/03/20/behave-03b-hotfix/" class="titleSmall">Behave 0.3b hotfix</a><br />
						
							<a href="/2009/03/19/path-tutorial-video-available/" class="titleSmall">Path tutorial video available</a><br />
						
							<a href="/2009/03/18/path-10-launched/" class="titleSmall">Path 1.0 launched!</a><br />
						
							<a href="/2008/12/17/community-tutorial-2/" class="titleSmall">Continued community tutorials</a><br />
						
							<a href="/2008/11/30/community-tutorial/" class="titleSmall">Community tutorial</a><br />
						
							<a href="/2008/11/28/new-tutorial/" class="titleSmall">New tutorial</a><br />
						
							<a href="/2008/11/04/first-tutorial-available/" class="titleSmall">First tutorial available</a><br />
						
							<a href="/2008/11/02/behave-03b/" class="titleSmall">Behave 0.3b</a><br />
						
							<a href="/2008/10/25/unite-08-open-mic-session/" class="titleSmall">unite '08 open-mic session</a><br />
						
							<a href="/2008/09/24/behave-02b/" class="titleSmall">Behave 0.2b</a><br />
						
							<a href="/2008/09/09/behave-01b/" class="titleSmall">Behave 0.1b</a><br />
						
							<a href="/2008/09/08/behave-pre-release/" class="titleSmall">Behave pre-release</a><br />
						
							<a href="/2008/04/15/path-beta-03b/" class="titleSmall">Path beta 0.3b</a><br />
						
							<a href="/2008/04/12/path-beta-02b/" class="titleSmall">Path beta 0.2b</a><br />
						
							<a href="/2008/04/05/path-beta-01b/" class="titleSmall">Path beta 0.1b</a><br />
						
							<a href="/2008/03/30/path-pre-release/" class="titleSmall">Path pre-release</a><br />
						
					</div>
				</div>
				<div id="footer">
	<div id="sidebar">
		<div id="external">
			<a href="/feed.xml">RSS</a>
			<a href="/feed.articles.xml">Full RSS</a>
			<a href="https://gist.github.com/AngryAnt">Gist</a>
			<a href="https://mastodon.eej.dk">Mastodon</a>
			<a href="https://twitter.com/AngryAnt">Twitter</a>
			<a href="http://eej.dk">LinkedIn</a>
			<a href="http://lanyrd.eej.dk">Lanyrd</a>
			<a href="http://connect.eej.dk">Unity Connect</a>
		</div>
	</div>
	<p class="footnote" style="margin-top: 50px; margin-bottom: 10px; clear: both;">Copyright &#169; AngryAnt&trade; <script>document.write ((new Date ()).getFullYear ());</script>. All public github gists are public domain.</p>
</div>

			</div>
		</div>
		

	</body>
</html>
